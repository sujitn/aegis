<?xml version='1.0' encoding='windows-1252'?>
<!-- Copyright (C) 2024 Aegis Team. WiX installer for Aegis. -->

<?if $(sys.BUILDARCH) = x64 or $(sys.BUILDARCH) = arm64 ?>
    <?define PlatformProgramFilesFolder = "ProgramFiles64Folder" ?>
<?else ?>
    <?define PlatformProgramFilesFolder = "ProgramFilesFolder" ?>
<?endif ?>

<Wix xmlns='http://schemas.microsoft.com/wix/2006/wi'>

    <Product
        Id='*'
        Name='Aegis AI Safety'
        UpgradeCode='A3E91F2D-4B5C-6D7E-8F9A-0B1C2D3E4F5A'
        Manufacturer='Aegis Team'
        Language='1033'
        Codepage='1252'
        Version='$(var.Version)'>

        <Package Id='*'
            Keywords='Installer'
            Description='Aegis AI Safety Platform - Parental controls for AI chatbots'
            Manufacturer='Aegis Team'
            InstallerVersion='450'
            Languages='1033'
            Compressed='yes'
            InstallScope='perMachine'
            SummaryCodepage='1252'
            />

        <MajorUpgrade
            Schedule='afterInstallInitialize'
            DowngradeErrorMessage='A newer version of [ProductName] is already installed. Setup will now exit.'/>

        <Media Id='1' Cabinet='media1.cab' EmbedCab='yes' DiskPrompt='CD-ROM #1'/>
        <Property Id='DiskPrompt' Value='Aegis AI Safety Installation'/>

        <Directory Id='TARGETDIR' Name='SourceDir'>
            <Directory Id='$(var.PlatformProgramFilesFolder)' Name='PFiles'>
                <Directory Id='APPLICATIONFOLDER' Name='Aegis'>

                    <Directory Id='Bin' Name='bin'>
                        <Component Id='Path' Guid='B4F02A3E-5C6D-7E8F-9A0B-1C2D3E4F5A6B' KeyPath='yes'>
                            <Environment
                                Id='PATH'
                                Name='PATH'
                                Value='[Bin]'
                                Permanent='no'
                                Part='last'
                                Action='set'
                                System='yes'/>
                        </Component>
                        <Component Id='binary0' Guid='*'>
                            <File
                                Id='exe0'
                                Name='aegis.exe'
                                DiskId='1'
                                Source='$(var.CargoTargetBinDir)\aegis.exe'
                                KeyPath='yes'/>
                        </Component>
                    </Directory>

                    <!-- Browser Extension folder -->
                    <Directory Id='ExtensionDir' Name='extension'>
                        <Component Id='ExtensionManifest' Guid='*'>
                            <File Id='manifest_json' Name='manifest.json' Source='$(var.CargoTargetBinDir)\..\..\extension\manifest.json' KeyPath='yes'/>
                        </Component>
                        <Component Id='ExtensionPopup' Guid='*'>
                            <File Id='popup_html' Name='popup.html' Source='$(var.CargoTargetBinDir)\..\..\extension\popup.html' KeyPath='yes'/>
                        </Component>
                        <Component Id='ExtensionOverlay' Guid='*'>
                            <File Id='overlay_css' Name='overlay.css' Source='$(var.CargoTargetBinDir)\..\..\extension\overlay.css' KeyPath='yes'/>
                        </Component>
                        <Directory Id='ExtensionDist' Name='dist'>
                            <Component Id='ExtensionDistContent' Guid='*'>
                                <File Id='content_js' Name='content.js' Source='$(var.CargoTargetBinDir)\..\..\extension\dist\content.js' KeyPath='yes'/>
                            </Component>
                            <Component Id='ExtensionDistBackground' Guid='*'>
                                <File Id='background_js' Name='background.js' Source='$(var.CargoTargetBinDir)\..\..\extension\dist\background.js' KeyPath='yes'/>
                            </Component>
                        </Directory>
                        <Directory Id='ExtensionIcons' Name='icons'>
                            <Component Id='ExtensionIcon16' Guid='*'>
                                <File Id='icon16_png' Name='icon16.png' Source='$(var.CargoTargetBinDir)\..\..\extension\icons\icon16.png' KeyPath='yes'/>
                            </Component>
                            <Component Id='ExtensionIcon32' Guid='*'>
                                <File Id='icon32_png' Name='icon32.png' Source='$(var.CargoTargetBinDir)\..\..\extension\icons\icon32.png' KeyPath='yes'/>
                            </Component>
                            <Component Id='ExtensionIcon48' Guid='*'>
                                <File Id='icon48_png' Name='icon48.png' Source='$(var.CargoTargetBinDir)\..\..\extension\icons\icon48.png' KeyPath='yes'/>
                            </Component>
                            <Component Id='ExtensionIcon128' Guid='*'>
                                <File Id='icon128_png' Name='icon128.png' Source='$(var.CargoTargetBinDir)\..\..\extension\icons\icon128.png' KeyPath='yes'/>
                            </Component>
                        </Directory>
                    </Directory>
                </Directory>
            </Directory>

            <Directory Id='ProgramMenuFolder'>
                <Directory Id='ApplicationProgramsFolder' Name='Aegis'>
                    <Component Id='ApplicationShortcut' Guid='*'>
                        <Shortcut Id='ApplicationStartMenuShortcut'
                            Name='Aegis'
                            Description='AI Safety Platform for Families'
                            Target='[#exe0]'
                            WorkingDirectory='APPLICATIONFOLDER'/>
                        <RemoveFolder Id='CleanUpShortCut' Directory='ApplicationProgramsFolder' On='uninstall'/>
                        <RegistryValue Root='HKCU' Key='Software\Aegis' Name='installed' Type='integer' Value='1' KeyPath='yes'/>
                    </Component>
                </Directory>
            </Directory>

            <Directory Id='DesktopFolder' Name='Desktop'>
                <Component Id='DesktopShortcut' Guid='*'>
                    <Shortcut Id='DesktopShortcut'
                        Name='Aegis'
                        Description='AI Safety Platform for Families'
                        Target='[#exe0]'
                        WorkingDirectory='APPLICATIONFOLDER'/>
                    <RegistryValue Root='HKCU' Key='Software\Aegis' Name='desktopshortcut' Type='integer' Value='1' KeyPath='yes'/>
                </Component>
            </Directory>
        </Directory>

        <Feature
            Id='Binaries'
            Title='Application'
            Description='Installs the Aegis executable and adds it to PATH.'
            Level='1'
            ConfigurableDirectory='APPLICATIONFOLDER'
            AllowAdvertise='no'
            Display='expand'
            Absent='disallow'>

            <ComponentRef Id='binary0'/>

            <Feature
                Id='Environment'
                Title='PATH Environment Variable'
                Description='Add Aegis to the PATH environment variable. This allows running aegis from any command prompt.'
                Level='1'
                Absent='allow'>
                <ComponentRef Id='Path'/>
            </Feature>

            <Feature
                Id='StartMenuShortcut'
                Title='Start Menu Shortcut'
                Description='Add a shortcut to the Start Menu.'
                Level='1'
                Absent='allow'>
                <ComponentRef Id='ApplicationShortcut'/>
            </Feature>

            <Feature
                Id='DesktopShortcutFeature'
                Title='Desktop Shortcut'
                Description='Add a shortcut to the Desktop.'
                Level='1'
                Absent='allow'>
                <ComponentRef Id='DesktopShortcut'/>
            </Feature>

            <Feature
                Id='BrowserExtension'
                Title='Browser Extension'
                Description='Install the browser extension for Chrome, Edge, and other Chromium browsers.'
                Level='1'
                Absent='allow'>
                <ComponentRef Id='ExtensionManifest'/>
                <ComponentRef Id='ExtensionPopup'/>
                <ComponentRef Id='ExtensionOverlay'/>
                <ComponentRef Id='ExtensionDistContent'/>
                <ComponentRef Id='ExtensionDistBackground'/>
                <ComponentRef Id='ExtensionIcon16'/>
                <ComponentRef Id='ExtensionIcon32'/>
                <ComponentRef Id='ExtensionIcon48'/>
                <ComponentRef Id='ExtensionIcon128'/>
            </Feature>
        </Feature>

        <SetProperty Id='ARPINSTALLLOCATION' Value='[APPLICATIONFOLDER]' After='CostFinalize'/>

        <Property Id='ARPHELPLINK' Value='https://github.com/sujitn/aegis'/>

        <UI>
            <UIRef Id='WixUI_FeatureTree'/>
            <Publish Dialog='WelcomeDlg' Control='Next' Event='NewDialog' Value='CustomizeDlg' Order='99'>1</Publish>
            <Publish Dialog='CustomizeDlg' Control='Back' Event='NewDialog' Value='WelcomeDlg' Order='99'>1</Publish>
        </UI>

    </Product>
</Wix>
